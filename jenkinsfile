pipeline {
    agent any
    
    environment {
        // Define environment variables
        APP_NAME = 'python-jenkins-demo'
        DOCKER_IMAGE = "${APP_NAME}"
        BUILD_VERSION = "${BUILD_NUMBER}"
        PYTHON_VERSION = '3.13'
    }
    
    options {
        // Keep only last 10 builds
        buildDiscarder(logRotator(numToKeepStr: '10'))
        
        // Timeout for entire pipeline
        timeout(time: 30, unit: 'MINUTES')
        
        // Timestamps in console output
        timestamps()
    }
    
    stages {
        stage('ğŸš€ Initialize') {
            steps {
                echo '=' * 60
                echo 'ğŸš€ Starting Jenkins CI/CD Pipeline'
                echo '=' * 60
                echo "ğŸ“‹ Build Information:"
                echo "   â†’ Project: ${APP_NAME}"
                echo "   â†’ Build Number: ${BUILD_NUMBER}"
                echo "   â†’ Build Version: ${BUILD_VERSION}"
                echo "   â†’ Python Version: ${PYTHON_VERSION}"
                echo "   â†’ Workspace: ${WORKSPACE}"
                echo '=' * 60
            }
        }
        
        stage('ğŸ“¥ Checkout Code') {
            steps {
                echo 'ğŸ“¥ Checking out code from repository...'
                script {
                    // Git checkout happens automatically in Jenkins
                    sh 'ls -la'
                    sh 'pwd'
                }
                echo 'âœ… Code checkout completed successfully!'
            }
        }
        
        stage('ğŸ Setup Python Environment') {
            steps {
                echo 'ğŸ Setting up Python environment...'
                sh '''
                    echo "Python version:"
                    python3 --version
                    
                    echo "Pip version:"
                    pip3 --version
                    
                    echo "Python path:"
                    which python3
                    
                    echo "Available Python modules:"
                    python3 -c "help('modules')" | head -20
                '''
                echo 'âœ… Python environment verified successfully!'
            }
        }
        
        stage('ğŸ“¦ Install Dependencies') {
            steps {
                echo 'ğŸ“¦ Installing project dependencies...'
                sh '''
                    # Upgrade pip
                    python3 -m pip install --upgrade pip
                    
                    # Install development dependencies (if requirements.txt exists)
                    if [ -f "requirements.txt" ]; then
                        echo "Installing from requirements.txt..."
                        pip3 install -r requirements.txt
                    else
                        echo "No requirements.txt found. No external dependencies to install."
                    fi
                    
                    # Verify Python can import our modules
                    python3 -c "import app; print('âœ… app.py imports successfully')"
                    python3 -c "import test_app; print('âœ… test_app.py imports successfully')"
                '''
                echo 'âœ… Dependencies installed successfully!'
            }
        }
        
        stage('ğŸ” Code Quality Check') {
            parallel {
                stage('Syntax Check') {
                    steps {
                        echo 'ğŸ” Performing Python syntax validation...'
                        sh '''
                            echo "Checking app.py syntax..."
                            python3 -m py_compile app.py
                            
                            echo "Checking test_app.py syntax..."
                            python3 -m py_compile test_app.py
                            
                            echo "âœ… All Python files have valid syntax!"
                        '''
                    }
                }
                
                stage('Import Check') {
                    steps {
                        echo 'ğŸ” Checking module imports...'
                        sh '''
                            echo "Testing imports..."
                            python3 -c "
import app
import test_app
print('âœ… All imports successful!')
print(f'Functions in app: {[func for func in dir(app) if not func.startswith(\"_\")]}')
"
                        '''
                    }
                }
            }
        }
        
        stage('ğŸ§ª Run Unit Tests') {
            steps {
                echo 'ğŸ§ª Executing comprehensive unit tests...'
                sh '''
                    echo "Running unit tests with detailed output..."
                    python3 test_app.py
                    
                    echo ""
                    echo "Running tests with unittest module for additional verification..."
                    python3 -m unittest test_app.py -v
                '''
                echo 'âœ… All unit tests passed successfully!'
            }
            post {
                always {
                    echo 'ğŸ“Š Unit test stage completed'
                }
            }
        }
        
        stage('ğŸš€ Run Application') {
            steps {
                echo 'ğŸš€ Executing the main application...'
                sh '''
                    echo "Running the Python application..."
                    python3 app.py
                    
                    echo ""
                    echo "Application execution completed successfully!"
                '''
                echo 'âœ… Application executed successfully!'
            }
        }
        
        stage('ğŸ³ Docker Operations') {
            stages {
                stage('Build Docker Image') {
                    steps {
                        echo 'ğŸ³ Building Docker image...'
                        script {
                            // Build Docker image with multiple tags
                            sh """
                                echo "Building Docker image: ${DOCKER_IMAGE}:${BUILD_VERSION}"
                                docker build -t ${DOCKER_IMAGE}:${BUILD_VERSION} .
                                
                                echo "Tagging as latest..."
                                docker build -t ${DOCKER_IMAGE}:latest .
                                
                                echo "Docker images built:"
                                docker images | grep ${DOCKER_IMAGE}
                            """
                        }
                        echo "âœ… Docker image built successfully: ${DOCKER_IMAGE}:${BUILD_VERSION}"
                    }
                }
                
                stage('Test Docker Image') {
                    steps {
                        echo 'ğŸ§ª Testing Docker image functionality...'
                        script {
                            sh """
                                echo "Testing application in Docker container..."
                                docker run --rm ${DOCKER_IMAGE}:latest
                                
                                echo ""
                                echo "Running unit tests in Docker container..."
                                docker run --rm ${DOCKER_IMAGE}:latest python3 test_app.py
                                
                                echo ""
                                echo "Testing Docker health check..."
                                docker run --rm ${DOCKER_IMAGE}:latest python3 -c "import app; print('Docker health check passed!')"
                            """
                        }
                        echo 'âœ… Docker image testing completed successfully!'
                    }
                }
                
                stage('Docker Security Scan') {
                    steps {
                        echo 'ğŸ”’ Performing basic Docker security checks...'
                        script {
                            sh """
                                echo "Checking Docker image details..."
                                docker inspect ${DOCKER_IMAGE}:latest | grep -E '(User|ExposedPorts|Volumes)'
                                
                                echo ""
                                echo "Checking image size..."
                                docker images ${DOCKER_IMAGE}:latest --format "table {{.Repository}}\\t{{.Tag}}\\t{{.Size}}"
                                
                                echo ""
                                echo "Verifying non-root user..."
                                docker run --rm ${DOCKER_IMAGE}:latest whoami
                            """
                        }
                        echo 'âœ… Docker security checks completed!'
                    }
                }
            }
        }
        
        stage('ğŸ“Š Generate Reports') {
            steps {
                echo 'ğŸ“Š Generating build reports...'
                script {
                    sh '''
                        echo "=== BUILD REPORT ===" > build-report.txt
                        echo "Build Number: ${BUILD_NUMBER}" >> build-report.txt
                        echo "Build Date: $(date)" >> build-report.txt
                        echo "Python Version: $(python3 --version)" >> build-report.txt
                        echo "Docker Image: ${DOCKER_IMAGE}:${BUILD_VERSION}" >> build-report.txt
                        echo "Git Commit: $(git rev-parse HEAD 2>/dev/null || echo 'N/A')" >> build-report.txt
                        echo "Workspace: ${WORKSPACE}" >> build-report.txt
                        echo "=== END REPORT ===" >> build-report.txt
                        
                        echo "Build report generated:"
                        cat build-report.txt
                    '''
                }
                echo 'âœ… Build reports generated successfully!'
            }
            post {
                always {
                    archiveArtifacts artifacts: 'build-report.txt', fingerprint: true
                }
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ Pipeline execution completed!'
            echo 'ğŸ§¹ Performing cleanup operations...'
            
            script {
                // Clean up old Docker images
                sh '''
                    echo "Current Docker images:"
                    docker images | grep ${DOCKER_IMAGE} || true
                    
                    echo "Cleaning up old Docker images (keeping last 5)..."
                    docker images ${DOCKER_IMAGE} --format "{{.Tag}}" | grep -E "^[0-9]+$" | sort -nr | tail -n +6 | xargs -r docker rmi ${DOCKER_IMAGE}: || true
                '''
            }
            
            // Clean workspace
            cleanWs()
            
            echo '=' * 60
            echo 'ğŸ Jenkins Pipeline Execution Summary:'
            echo "   â†’ Status: ${currentBuild.currentResult}"
            echo "   â†’ Duration: ${currentBuild.durationString}"
            echo "   â†’ Build: #${BUILD_NUMBER}"
            echo '=' * 60
        }
        
        success {
            echo 'ğŸ‰ PIPELINE COMPLETED SUCCESSFULLY! ğŸ‰'
            echo 'âœ… All stages passed without errors'
            echo 'ğŸš€ Application is ready for deployment!'
            
            // You can add notifications here
            // emailext (
            //     subject: "âœ… Build Success: ${env.JOB_NAME} - #${env.BUILD_NUMBER}",
            //     body: "The pipeline completed successfully!",
            //     to: "your-email@example.com"
            // )
        }
        
        failure {
            echo 'âŒ PIPELINE FAILED!'
            echo 'ğŸ” Please check the console output for error details'
            echo 'ğŸ› ï¸  Fix the issues and retry the build'
            
            // You can add failure notifications here
            // emailext (
            //     subject: "âŒ Build Failed: ${env.JOB_NAME} - #${env.BUILD_NUMBER}",
            //     body: "The pipeline failed. Please check the logs.",
            //     to: "your-email@example.com"
            // )
        }
        
        unstable {
            echo 'âš ï¸  PIPELINE UNSTABLE'
            echo 'ğŸ“Š Some tests may have failed or there are warnings'
        }
        
        changed {
            echo 'ğŸ”„ Pipeline status changed from previous build'
        }
    }
}